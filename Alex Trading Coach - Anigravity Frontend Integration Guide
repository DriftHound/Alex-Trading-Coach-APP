# Alex Trading Coach - Anigravity Frontend Integration Guide

**Date:** December 4, 2024  
**For:** Anigravity Development Team  
**Project:** Alex Trading Coach Next.js Frontend  
**Backend API:** Manus VM

---

## Executive Summary

This document provides complete instructions for integrating the Anigravity Next.js frontend with the Alex Trading Coach Manus backend API. The backend has been configured with **Google OAuth authentication** to provide a seamless, branded user experience without redirecting to external OAuth portals.

**Key Points:**
- ✅ Backend API is fully operational with REST endpoints
- ✅ Google OAuth authentication implemented (no Manus redirect required)
- ✅ CORS enabled for cross-origin requests from Netlify
- ✅ All 6 workflow steps available as REST endpoints
- ✅ Complete API documentation provided

---

## Table of Contents

1. [Authentication Setup](#1-authentication-setup)
2. [API Configuration](#2-api-configuration)
3. [Workflow Implementation](#3-workflow-implementation)
4. [Critical Validation Gates](#4-critical-validation-gates)
5. [Trade Journal Integration](#5-trade-journal-integration)
6. [Error Handling](#6-error-handling)
7. [Testing Checklist](#7-testing-checklist)
8. [Troubleshooting](#8-troubleshooting)

---

## 1. Authentication Setup

### Overview

The backend uses **Google OAuth** for authentication. Users sign in with Google directly on your Next.js frontend, and the backend verifies the Google ID token and returns a JWT for subsequent API calls.

### Step 1.1: Obtain Google OAuth Credentials

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select existing project
3. Navigate to **APIs & Services** → **Credentials**
4. Click **Create Credentials** → **OAuth 2.0 Client ID**
5. Configure consent screen if prompted
6. Application type: **Web application**
7. Add authorized JavaScript origins:
   ```
   https://alex-trading-coach-app.netlify.app
   http://localhost:3000 (for development)
   ```
8. Copy the **Client ID** (format: `123456789-abc123def456.apps.googleusercontent.com`)

### Step 1.2: Install Google OAuth Library

```bash
npm install @react-oauth/google
```

### Step 1.3: Configure Environment Variables

Create `.env.local` in your Next.js project:

```env
# Google OAuth
NEXT_PUBLIC_GOOGLE_CLIENT_ID=your-google-client-id-here

# Manus Backend API
NEXT_PUBLIC_API_BASE_URL=https://3000-ivs6mmlhg9m3tj3d6stg6-3c645c19.manusvm.computer/api/agents
```

**Important:** The Manus VM URL is temporary. For production, use the published `*.manus.space` domain.

### Step 1.4: Wrap App with Google OAuth Provider

```typescript
// app/layout.tsx or _app.tsx
import { GoogleOAuthProvider } from '@react-oauth/google';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body>
        <GoogleOAuthProvider clientId={process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID!}>
          {children}
        </GoogleOAuthProvider>
      </body>
    </html>
  );
}
```

### Step 1.5: Implement Login Page

```typescript
// app/login/page.tsx
'use client';

import { GoogleLogin } from '@react-oauth/google';
import axios from 'axios';
import { useRouter } from 'next/navigation';

export default function LoginPage() {
  const router = useRouter();

  const handleGoogleSuccess = async (credentialResponse: any) => {
    try {
      // Send Google ID token to Manus backend
      const response = await axios.post(
        `${process.env.NEXT_PUBLIC_API_BASE_URL}/google-login`,
        { idToken: credentialResponse.credential }
      );

      // Store JWT token and user info
      localStorage.setItem('authToken', response.data.token);
      localStorage.setItem('user', JSON.stringify(response.data.user));

      // Configure Axios default headers
      axios.defaults.headers.common['Authorization'] = `Bearer ${response.data.token}`;

      // Redirect to dashboard
      router.push('/dashboard');
    } catch (error: any) {
      console.error('Login failed:', error);
      alert(`Login failed: ${error.response?.data?.error || 'Please try again'}`);
    }
  };

  const handleGoogleError = () => {
    console.error('Google Sign-In failed');
    alert('Google Sign-In failed. Please try again.');
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 to-gray-900">
      <div className="bg-gray-800 p-8 rounded-lg shadow-2xl max-w-md w-full">
        <div className="text-center mb-8">
          <div className="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg className="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
            </svg>
          </div>
          <h1 className="text-3xl font-bold text-white mb-2">Alex Trading Coach</h1>
          <p className="text-gray-400">Professional FX Trading with AI Validation</p>
        </div>

        <div className="flex justify-center">
          <GoogleLogin
            onSuccess={handleGoogleSuccess}
            onError={handleGoogleError}
            theme="filled_blue"
            size="large"
            text="signin_with"
            shape="rectangular"
          />
        </div>

        <p className="text-gray-500 text-sm text-center mt-6">
          Trade with discipline. Follow the Alex methodology.
        </p>
      </div>
    </div>
  );
}
```

### Step 1.6: Create Axios Instance with Authentication

```typescript
// lib/api.ts
import axios from 'axios';

const apiClient = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_BASE_URL,
});

// Add auth token to all requests
apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem('authToken');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// Handle 401 errors (token expired)
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Token expired or invalid - redirect to login
      localStorage.removeItem('authToken');
      localStorage.removeItem('user');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

export default apiClient;
```

---

## 2. API Configuration

### Base URL

```
https://3000-ivs6mmlhg9m3tj3d6stg6-3c645c19.manusvm.computer/api/agents
```

**Note:** This is a temporary VM URL. For production deployment, use the published `*.manus.space` domain.

### Request Headers

All API requests must include the JWT token:

```typescript
headers: {
  'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
  'Content-Type': 'application/json'
}
```

### Response Format

All responses follow this structure:

```typescript
{
  success: boolean;
  data?: any;        // Present on success
  error?: string;    // Present on failure
}
```

---

## 3. Workflow Implementation

The Alex Trading Coach workflow consists of 6 sequential steps. Each step must be completed before proceeding to the next.

### Step 1: Market & Session Check

**Purpose:** Validate that trading occurs within "Alex Time" (1:00-10:30 AM EST, London/NY sessions).

**Implementation:**

```typescript
// Check if current time is within Alex Time
function isAlexTime(): boolean {
  const now = new Date();
  const estTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
  const hour = estTime.getHours();
  const minute = estTime.getMinutes();
  
  const currentMinutes = hour * 60 + minute;
  const startMinutes = 1 * 60 + 0;  // 1:00 AM
  const endMinutes = 10 * 60 + 30;  // 10:30 AM
  
  return currentMinutes >= startMinutes && currentMinutes <= endMinutes;
}

// Display warning if outside Alex Time
if (!isAlexTime()) {
  showWarning('You are outside Alex Time (1:00-10:30 AM EST). Proceed with caution.');
}
```

### Step 2: Trend Analysis

**Endpoint:** `POST /api/agents/validate_trend`

**Request:**

```typescript
const trendData = {
  pair: 'EURUSD',
  weeklyTrend: 'bullish',
  dailyTrend: 'bullish',
  fourhTrend: 'bullish',
  description: 'Clear uptrend across all timeframes with higher highs and higher lows',
  chartContext: 'Price above 20/50/200 EMAs on all timeframes',
  screenshotUrl: 'https://storage.example.com/chart-trend.png' // Optional
};

const response = await apiClient.post('/validate_trend', trendData);
```

**Response:**

```typescript
{
  success: true,
  data: {
    isValid: true,
    confidence: 85,
    feedback: "Excellent trend alignment...",
    warnings: [],
    recommendation: "PROCEED" | "CAUTION" | "STAND_DOWN"
  }
}
```

**Validation Gate:**
- If `recommendation === "STAND_DOWN"`, block progression to Step 3
- Display `feedback` and `warnings` to user

### Step 3: AOI Mapping

**Endpoint:** `POST /api/agents/validate_aoi`

**Request:**

```typescript
const aoiData = {
  pair: 'EURUSD',
  aoiType: 'Support',
  aoiLevel: '1.0850',
  description: 'Strong support level with multiple touches',
  chartContext: 'Confluence with 61.8% Fibonacci retracement',
  screenshotUrl: 'https://storage.example.com/chart-aoi.png' // Optional
};

const response = await apiClient.post('/validate_aoi', aoiData);
```

**Response:**

```typescript
{
  success: true,
  data: {
    isValid: true,
    confidence: 82,
    feedback: "Strong AOI placement...",
    confluenceFactors: ["Fibonacci 61.8%", "Previous support", "Round number"],
    warnings: [],
    recommendation: "PROCEED" | "CAUTION" | "STAND_DOWN"
  }
}
```

**Validation Gate:**
- If `recommendation === "STAND_DOWN"`, block progression to Step 4

### Step 4: Entry Pattern & Signal

**Endpoint:** `POST /api/agents/validate_pattern`

**Request:**

```typescript
const patternData = {
  pair: 'EURUSD',
  patternType: 'Bullish Engulfing',
  entryType: 'Breakout',
  entryLevel: '1.0860',
  evidence: 'Strong bullish engulfing candle at support with increased volume',
  chartContext: 'Pattern formed at AOI confluence zone',
  screenshotUrl: 'https://storage.example.com/chart-pattern.png' // Optional
};

const response = await apiClient.post('/validate_pattern', patternData);
```

**Response:**

```typescript
{
  success: true,
  data: {
    isValid: true,
    confidence: 88,
    confluenceScore: 75,
    feedback: "Clear entry pattern...",
    warnings: [],
    recommendation: "PROCEED" | "CAUTION" | "STAND_DOWN"
  }
}
```

**Critical Validation Gate:**
- If `confluenceScore < 60`, **MUST block progression** to Step 5
- Display error: "Confluence score too low. Minimum 60 required."

### Step 5: Risk & R:R Constraint

**Endpoint:** `POST /api/agents/calculate_risk`

**Request:**

```typescript
const riskData = {
  pair: 'EURUSD',
  entryLevel: '1.0860',
  stopLoss: '1.0830',
  takeProfit: '1.0920',
  accountBalance: 10000,
  riskPercentage: 1.0
};

const response = await apiClient.post('/calculate_risk', riskData);
```

**Response:**

```typescript
{
  success: true,
  data: {
    rrValid: true,
    lotSize: '0.67',
    stopLossPips: 30.0,
    targetPips: 60.0,
    rrRatio: '1:2.00',
    feedback: "Risk management meets Alex Bible standards...",
    warnings: [],
    recommendation: "PROCEED" | "REJECT"
  }
}
```

**Critical Validation Gate:**
- If `rrValid === false`, **MUST block progression** to Step 6
- Display error: "R:R ratio below 1:2 minimum. Adjust stop loss or take profit."

### Step 6: Final Checklist & Journal Entry

**6A: Final Checklist Validation**

**Endpoint:** `POST /api/agents/final_checklist_validation`

**Request:**

```typescript
const checklist = {
  trendAlignment: true,
  aoiConfluence: true,
  sessionTiming: true,
  riskManagement: true,
  emotionalState: true
};

const response = await apiClient.post('/final_checklist_validation', checklist);
```

**Response:**

```typescript
{
  success: true,
  data: {
    finalApproval: true,
    checklist: { ... },
    message: "All checklist items confirmed. You may proceed to journal entry."
  }
}
```

**Critical Validation Gate:**
- If `finalApproval === false`, **MUST block journal entry**
- User must check all 5 items before proceeding

**6B: Journal Entry**

**Endpoint:** `POST /api/agents/journal_entry`

**Request:**

```typescript
const journalData = {
  pair: 'EURUSD',
  trendWeekly: 'bullish',
  trendDaily: 'bullish',
  trendFourH: 'bullish',
  aoiType: 'Support',
  aoiLevel: '1.0850',
  patternType: 'Bullish Engulfing',
  entryLevel: '1.0860',
  stopLoss: '1.0830',
  takeProfit: '1.0920',
  lotSize: '0.67',
  rrRatio: '1:2.00',
  confluenceScore: 75,
  tags: ['breakout', 'london-session', 'high-confluence']
};

const response = await apiClient.post('/journal_entry', journalData);
```

**Response:**

```typescript
{
  success: true,
  data: {
    tradeId: 123,
    thesis: "AI-generated professional trade thesis...",
    tradeTicket: "=== ALEX TRADE TICKET ===\nPair: EURUSD\nEntry: 1.0860\n..."
  }
}
```

**Display:**
- Show the AI-generated `thesis` to user
- Display formatted `tradeTicket` for copying to MT5

---

## 4. Critical Validation Gates

These validation gates **MUST** be enforced on the frontend. Do not allow users to bypass these checks.

### Gate 1: Confluence Score Minimum

```typescript
if (patternResponse.data.confluenceScore < 60) {
  setError('Confluence score too low (minimum 60 required)');
  setCanProceed(false);
  return;
}
```

### Gate 2: R:R Ratio Minimum

```typescript
if (!riskResponse.data.rrValid) {
  setError('R:R ratio must be at least 1:2');
  setCanProceed(false);
  return;
}
```

### Gate 3: Final Checklist Complete

```typescript
const allChecked = Object.values(checklist).every(v => v === true);
if (!allChecked) {
  setError('Please complete all checklist items');
  setCanProceed(false);
  return;
}
```

---

## 5. Trade Journal Integration

### Fetch All Trades

**Endpoint:** `GET /api/agents/trades`

```typescript
const response = await apiClient.get('/trades');

// Response
{
  success: true,
  data: [
    {
      id: 123,
      pair: 'EURUSD',
      entryLevel: '1.0860',
      stopLoss: '1.0830',
      takeProfit: '1.0920',
      status: 'active' | 'closed',
      outcome: 'win' | 'loss' | 'sl_hit' | 'tp_hit' | 'manual_close',
      createdAt: '2024-12-04T10:30:00Z',
      // ... other fields
    }
  ]
}
```

### Log Trade Outcome

**Endpoint:** `POST /api/agents/log_outcome`

```typescript
const outcomeData = {
  tradeId: 123,
  outcome: 'win',
  actualEntry: '1.0860',
  actualExit: '1.0920',
  pnl: '400.00'
};

const response = await apiClient.post('/log_outcome', outcomeData);
```

### Get AI Coaching Insights

**Endpoint:** `GET /api/agents/journal_analysis`

```typescript
const response = await apiClient.get('/journal_analysis');

// Response
{
  success: true,
  data: {
    insights: "AI-generated coaching insights...",
    winRate: 75,
    avgRR: 2.5,
    bestPatterns: ['Bullish Engulfing', 'Pin Bar'],
    recommendations: ['Focus on London session', 'Increase position size on high confluence']
  }
}
```

---

## 6. Error Handling

### Standard Error Response

```typescript
{
  success: false,
  error: "Error message here"
}
```

### Common Error Codes

| Status Code | Meaning | Action |
|-------------|---------|--------|
| 401 | Unauthorized | Redirect to login |
| 400 | Bad Request | Display validation errors |
| 500 | Server Error | Show generic error, log details |

### Error Handling Example

```typescript
try {
  const response = await apiClient.post('/validate_trend', trendData);
  // Handle success
} catch (error: any) {
  if (error.response?.status === 401) {
    // Redirect to login
    router.push('/login');
  } else if (error.response?.status === 400) {
    // Display validation error
    setError(error.response.data.error);
  } else {
    // Generic error
    setError('An unexpected error occurred. Please try again.');
    console.error('API Error:', error);
  }
}
```

---

## 7. Testing Checklist

### Authentication
- [ ] Google Sign-In button displays correctly
- [ ] Successful login stores JWT token
- [ ] Token is included in all API requests
- [ ] 401 errors redirect to login page
- [ ] Logout clears token and redirects

### Workflow Steps
- [ ] Step 1: Session time warning displays outside Alex Time
- [ ] Step 2: Trend validation blocks on STAND_DOWN recommendation
- [ ] Step 3: AOI validation blocks on STAND_DOWN recommendation
- [ ] Step 4: Pattern validation blocks if confluence < 60
- [ ] Step 5: Risk calculation blocks if R:R < 1:2
- [ ] Step 6: Checklist blocks journal entry if incomplete
- [ ] Step 6: Trade ticket displays correctly

### Validation Gates
- [ ] Cannot proceed with confluence score < 60
- [ ] Cannot proceed with R:R ratio < 1:2
- [ ] Cannot create journal entry without all checklist items

### Trade Journal
- [ ] Trades list displays correctly
- [ ] Outcome logging works
- [ ] AI coaching insights display

---

## 8. Troubleshooting

### Issue: "JSON.parse: unexpected character" Error

**Cause:** Trying to parse HTML response as JSON (usually from OAuth redirect)

**Solution:** Ensure you're using the Google OAuth method, not redirecting to Manus OAuth portal

### Issue: CORS Error

**Cause:** Browser blocking cross-origin requests

**Solution:** 
1. Verify backend CORS is enabled (it is)
2. Ensure you're using HTTPS on Netlify
3. Check that API base URL is correct

### Issue: 401 Unauthorized

**Cause:** Missing or invalid JWT token

**Solution:**
1. Check that token is stored in localStorage
2. Verify token is included in Authorization header
3. Check token hasn't expired (7-day expiry)
4. Re-login to get fresh token

### Issue: Validation Gate Not Blocking

**Cause:** Frontend not checking validation response

**Solution:** Implement all validation gates as shown in Section 4

---

## Contact & Support

For technical questions or issues:
- **Backend API Issues:** Contact Manus team
- **Frontend Integration:** Refer to this guide
- **Google OAuth Setup:** See [Google OAuth Documentation](https://developers.google.com/identity/gsi/web/guides/overview)

---

**Document Version:** 1.0  
**Last Updated:** December 4, 2024  
**Author:** Manus AI
